<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">文章详情</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">

  <!-- 标题 -->
  <h1 th:text="${post.title}" class="post-title"></h1>

  <!-- 元信息 -->
  <div class="post-meta">
    <p>作者：
      <a th:href="@{'/user/' + ${post.author.username}}" class="author-link"
             th:text="${post.author.username}"></a></p>
    <p>发布时间：<span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
  </div>
  <p>可见性：
    <span th:switch="${post.visibility}">
    <span th:case="'PUBLIC'">公开</span>
    <span th:case="'FOLLOWERS'">粉丝可见</span>
    <span th:case="'PRIVATE'">私密</span>
  </span>
  </p>

<!--  点赞模块-->
  <button id="like-btn"
          th:data-post-id="${post.id}"
          th:text="${isLiked} ? '❤️ 已点赞' : '🤍 点赞'">
  </button>

  <span id="like-count" th:text="${likeCount}"></span>

  <!-- 文章内容 -->
  <div class="post-content" th:utext="${post.content}"></div>

  <hr>

  <!-- 评论区 -->
  <h2>评论区</h2>
  <div class="comment-section">

    <!-- 没有评论提示 -->
    <p th:if="${#lists.isEmpty(post.comments)}">还没有评论，快来抢沙发吧！</p>

    <!-- 评论列表 -->
    <div th:each="comment : ${post.comments}" class="comment">
      <div class="comment-header">
        <strong th:text="${comment.author.username}">评论者</strong>
        <span class="comment-date"
              th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
      </div>
      <p th:text="${comment.content}"></p>

      <!-- 删除评论按钮 -->
      <form th:if="${#authentication.name == comment.author.username or #authentication.name == post.author.username}"
            th:action="@{'/posts/' + ${post.id} + '/comments/' + ${comment.id} + '/delete'}"
            method="post"
            onsubmit="return confirm('确定要删除这条评论吗？');"
            style="display:inline;">
        <button type="submit" class="btn-delete">删除</button>
      </form>

      <!-- 子评论区 -->
      <div th:if="${not #lists.isEmpty(comment.replies)}" class="child-comments">
        <div th:each="reply : ${comment.replies}" class="reply">
          <div class="comment-header">
            <strong th:text="${reply.author.username}">评论者</strong>
            <span class="comment-date"
                  th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
          </div>
          <p th:text="${reply.content}"></p>

          <!-- 删除子评论按钮 -->
          <form th:if="${#authentication.name == reply.author.username or #authentication.name == post.author.username}"
                th:action="@{'/posts/' + ${post.id} + '/comments/' + ${reply.id} + '/delete'}"
                method="post"
                onsubmit="return confirm('确定要删除这条评论吗？');"
                style="display:inline;">
            <button type="submit" class="btn-delete">删除</button>
          </form>
        </div>
      </div>

      <!-- 回复评论按钮 -->
      <div th:if="${#authorization.expression('isAuthenticated()')}">
        <form th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post">
          <textarea name="content" rows="3" cols="50" th:placeholder="'回复'+ ${comment.author.username} + '的评论' " required></textarea>
          <input type="hidden" name="parentId" th:value="${comment.id}"/>
          <br>
          <button type="submit" class="btn-submit">提交回复</button>
        </form>
      </div>
    </div>
  </div>

  <hr>

  <!-- 发表评论 -->
  <div th:if="${#authorization.expression('isAuthenticated()')}" class="comment-form">
    <h3>发表评论</h3>
    <form th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post">
      <textarea name="content" rows="4" cols="60" placeholder="写下你的评论..." required></textarea>
      <br>
      <button type="submit" class="btn-submit">提交评论</button>
    </form>
  </div>

  <!-- 未登录提示 -->
  <p th:if="${!#authorization.expression('isAuthenticated()')}">
    <a th:href="@{/login}">登录</a> 后才能发表评论。
  </p>

  <hr>

  <p><a th:href="@{/}">返回首页</a></p>
</div>


<script>
  // 当整个页面加载完毕（HTML、CSS、图片等资源都准备好）后执行
  document.addEventListener("DOMContentLoaded", function() {

    // 获取点赞按钮和显示点赞数的元素
    const likeBtn = document.getElementById("like-btn");
    const likeCountSpan = document.getElementById("like-count");

    //监听点赞按钮的点击事件
    likeBtn.addEventListener("click", function() {

      // 从按钮中获取当前文章的 ID（通过 data-post-id 属性）
      const postId = this.getAttribute("data-post-id");

      //    使用 fetch 向后端发送异步请求（AJAX）
      //    URL 形如：/like/5
      //    方法：POST（对应后端的 @PostMapping("/{postId}")）
      fetch(`/like/${postId}`, {
        method: "POST",
        headers: {
          // 说明是 AJAX 请求（Spring 可根据此判断是否返回 JSON）
          "X-Requested-With": "XMLHttpRequest" }
      })
              //将服务器响应的数据解析为 JSON 格式
              .then(response => response.json())
              //解析后端返回的数据（包含 liked 状态 和 likeCount 数量）
              .then(data => {
                // 根据返回的 liked 状态更新按钮文字（实现状态切换）
                likeBtn.textContent = data.liked ? "❤️ 已点赞" : "🤍 点赞";
                // 更新点赞数量显示（实时刷新）
                likeCountSpan.textContent = data.likeCount;
              })

              // 捕获请求失败的情况（比如网络错误）
              .catch(err => console.error("点赞失败:", err));
    });
  });
</script>

</body>
</html>
